{
    "name": "BWA Alignment",
    "workdir": "{resultdir}",
    "prevent_global": ["resultdir"],
    "tasks": [
    {
        "name": "Trimming Reads",
        "command": "trim_galore raw_reads.fq.gz",
        "depends": "raw_reads.fq.gz",
        "produces": "raw_reads_trimmed.fq.gz"
    },
    {
        "name": "Mapping Reads (Step 1)",
        "command": "bwa aln -t {threads} {assembly} raw_reads_trimmed.fq.gz > bwa_aln.sai",
        "depends": ["raw_reads_trimmed.fq.gz", "{assembly}.bwt"],
        "produces": "bwa_aln.sai"
    },
    {
        "name": "Mapping Reads (Step 2)",
        "command": "bwa samse {assembly} bwa_aln.sai raw_reads_trimmed.fq.gz | samtools view -bS - > bwa_aln.bam",
        "depends": ["{assembly}.bwt", "bwa_aln.sai", "raw_reads_trimmed.fq.gz"],
        "produces": "bwa_aln.bam"
    },
    {
        "name": "Filtering Alignments",
        "command": "samtools view -F 1804 -q 30 -b bwa_aln.bam > filter1.bam",
        "depends": "bwa_aln.bam",
        "produces": "filter1.bam"
    },
    {
        "name": "Sorting BAM",
        "command": "samtools sort -@ {threads} -o sorted.bam filter1.bam",
        "depends": "filter1.bam",
        "produces": "sorted.bam"
    },
    {
        "name": "Marking Duplicates",
        "command": "picard-tools MarkDuplicates INPUT=sorted.bam OUTPUT=dup_marked.bam METRICS_FILE=dup_metrics.txt VALIDATION_STRINGENCY=LENIENT ASSUME_SORTED=true REMOVE_DUPLICATES=false",
        "depends": "sorted.bam",
        "produces": ["dup_marked.bam", "dup_metrics.txt"]
    },
    {
        "name": "Removing Duplicates",
        "command": "samtools view -F 1804 -q 30 -b dup_marked.bam > filter2.bam",
        "depends": "dup_marked.bam",
        "produces": "filter2.bam"
    },
    {
        "name": "Calculating QC Metrics",
        "command": "bamToBed -i filter1.bam | awk 'BEGIN{{OFS=\"\\t\"}}{{print $1,$2,$4,$6,$9,$10}}' | sort | uniq -c | awk 'BEGIN{{mt=1;m0=1;m1=1;m2=1}} ($1==1){{m1=m1+1}} ($1==2){{m2=m2+1}} {{m0=m0+1}} {{mt=mt+$1}} END{{printf \"Total Reads:\\t%d\\nDistinct Reads:\\t%d\\nOne Read:\\t%d\\nTwo Reads:\\t%d\\nNRF:\\t%f\\nPBC1:\\t%f\\nPBC2:\\t%f\\n\",mt,m0,m1,m2,m0/mt,m1/m0,m1/m2}}' > qc_metrics.txt",
        "depends": "filter1.bam",
        "produces": "qc_metrics.txt"
    }
    ]
}
